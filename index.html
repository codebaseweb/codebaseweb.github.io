<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Diablo: Тёмная тропа — полная версия</title>
  <style>
    :root {
      --bg: #0b0d12; --panel: #131720; --text: #e6edf3; --muted: #9aa3b2;
      --accent: #c43b3b; --magic: #3ba3ff; --rare: #e3c045; --good:#7dd97d; --evil:#ff7b7b;
    }
    body { margin:0; background:var(--bg); color:var(--text); font:16px/1.6 system-ui,sans-serif; }
    main { max-width:900px; margin:24px auto; padding:20px; background:var(--panel); border:1px solid #222736; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.35); }
    h1 { margin:0 0 12px 0; }
    .status { display:grid; grid-template-columns:repeat(6,1fr); gap:10px; margin-bottom:15px; }
    .card { background:#0f131b; border:1px solid #23283a; padding:10px; border-radius:8px; }
    .label { font-size:13px; color:var(--muted); }
    .value { font-weight:600; }
    .output { min-height:160px; background:#0f131b; border:1px solid #23283a; border-radius:8px; padding:12px; margin-bottom:12px; }
    .choices { display:grid; gap:8px; }
    button.choice { padding:10px; background:#151a24; border:1px solid #2a3040; border-radius:8px; color:var(--text); text-align:left; cursor:pointer; transition:border-color 120ms ease, transform 120ms ease; }
    button.choice:hover { border-color:var(--accent); transform: translateY(-1px); }
    .controls { margin-top:12px; display:flex; justify-content:space-between; align-items:center; }
    #restart { padding:10px 14px; background:#121620; border:1px solid #2a3040; border-radius:8px; color:var(--text); cursor:pointer; }
    #restart:hover { border-color:var(--accent); }
    .item-magic { color:var(--magic); }
    .item-rare { color:var(--rare); }
    .good { color:var(--good); }
    .evil { color:var(--evil); }
    @media (max-width:760px){ .status { grid-template-columns:repeat(3,1fr); } }
    @media (max-width:520px){ .status { grid-template-columns:repeat(2,1fr); } }
  </style>
</head>
<body>
  <main>
    <h1>Diablo: Тёмная тропа</h1>
    <section id="status" class="status"></section>
    <section id="output" class="output"></section>
    <section id="choices" class="choices"></section>
    <section class="controls">
      <div class="credits">Музыка и SFX: Pixabay (free). Без изображений.</div>
      <button id="restart">Начать заново</button>
    </section>
  </main>

  <!-- Аудио: эмбиенты и эффекты -->
  <audio id="ambient_city" src="https://cdn.pixabay.com/download/audio/2021/10/26/audio_8c3f57a6f5.mp3?filename=dark-atmosphere-ambient-96207.mp3" preload="auto" loop></audio>
  <audio id="ambient_forest" src="https://cdn.pixabay.com/download/audio/2022/02/07/audio_c5a5d2f6df.mp3?filename=dark-forest-ambient-100334.mp3" preload="auto" loop></audio>
  <audio id="ambient_catacombs" src="https://cdn.pixabay.com/download/audio/2021/11/28/audio_9cb22f4b6d.mp3?filename=dark-dungeon-ambient-94161.mp3" preload="auto" loop></audio>

  <audio id="sfx_click" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_620eab44f1.mp3?filename=ui-click-102923.mp3" preload="auto"></audio>
  <audio id="sfx_attack" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2d9fff143f.mp3?filename=sword-swing-102925.mp3" preload="auto"></audio>
  <audio id="sfx_hit" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_2e2b5ba05a.mp3?filename=body-hit-102926.mp3" preload="auto"></audio>
  <audio id="sfx_crit" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_8da6c4f1f3.mp3?filename=critical-hit-102924.mp3" preload="auto"></audio>
  <audio id="sfx_loot" src="https://cdn.pixabay.com/download/audio/2021/08/08/audio_bf2c629af0.mp3?filename=magic-item-6014.mp3" preload="auto"></audio>
  <audio id="sfx_portal" src="https://cdn.pixabay.com/download/audio/2022/01/06/audio_5f2e9e0b97.mp3?filename=portal-99073.mp3" preload="auto"></audio>
  <audio id="sfx_boss" src="https://cdn.pixabay.com/download/audio/2022/01/06/audio_7ad748d7d9.mp3?filename=demon-growl-99075.mp3" preload="auto"></audio>

  <script>
    // ===== Состояние =====
    const state = {
      name: "Странник",
      cls: null,               // "Воин" | "Монах" | "Колдун"
      hp: 24, maxHp: 24,
      gold: 0, level: 1,
      baseDmg: 4,
      weapon: null,            // {type:"weapon", name, min, max, rarity, affix}
      inventory: [],           // предметы, ключи, флаконы
      reputation: 0,           // >0 — доблесть, <0 — тьма
      companion: null,         // {name, bonus}
      location: "intro",
      flags: {},               // сюжетные флаги, квесты
      soundOn: true
    };

    // ===== Элементы =====
    const $status = document.getElementById("status");
    const $output = document.getElementById("output");
    const $choices = document.getElementById("choices");
    const $restart = document.getElementById("restart");

    // ===== Аудио =====
    const audio = {
      ambient_city: document.getElementById("ambient_city"),
      ambient_forest: document.getElementById("ambient_forest"),
      ambient_catacombs: document.getElementById("ambient_catacombs"),
      click: document.getElementById("sfx_click"),
      attack: document.getElementById("sfx_attack"),
      hit: document.getElementById("sfx_hit"),
      crit: document.getElementById("sfx_crit"),
      loot: document.getElementById("sfx_loot"),
      portal: document.getElementById("sfx_portal"),
      boss: document.getElementById("sfx_boss")
    };

    function play(name){
      const el = audio[name];
      if(!el || !state.soundOn) return;
      el.currentTime = 0;
      el.play().catch(()=>{});
    }
    function stopAmbients(){
      audio.ambient_city.pause();
      audio.ambient_forest.pause();
      audio.ambient_catacombs.pause();
    }
    function setAmbientByLocation(loc){
      if(!state.soundOn) return;
      stopAmbients();
      const map = {
        intro: "ambient_city",
        camp: "ambient_city",
        tristram: "ambient_city",
        tower: "ambient_city",
        forest: "ambient_forest",
        fields: "ambient_forest",
        chapel: "ambient_city",
        catacombs: "ambient_catacombs",
        crypt: "ambient_catacombs",
        deepCatacombs: "ambient_catacombs"
      };
      const key = map[loc] || "ambient_city";
      audio[key].volume = 0.5;
      audio[key].play().catch(()=>{});
    }

    // ===== UI =====
    function say(text){ $output.innerHTML = `<p>${text}</p>`; }
    function renderItem(item){
      if(!item) return "без оружия";
      const cls = item.rarity==="magic" ? "item-magic" : item.rarity==="rare" ? "item-rare" : "";
      const aff = item.affix ? ` (${item.affix})` : "";
      return `<span class="${cls}">${item.name} [${item.min}-${item.max}]${aff}</span>`;
    }
    function showStatus(){
      $status.innerHTML = `
        <div class="card"><div class="label">Класс</div><div class="value">${state.cls||"?"}</div></div>
        <div class="card"><div class="label">Здоровье</div><div class="value">${state.hp}/${state.maxHp}</div></div>
        <div class="card"><div class="label">Золото</div><div class="value">${state.gold}</div></div>
        <div class="card"><div class="label">Оружие</div><div class="value">${renderItem(state.weapon)}</div></div>
        <div class="card"><div class="label">Репутация</div><div class="value">${state.reputation>=0?'<span class="good">Доблесть '+state.reputation+'</span>':'<span class="evil">Тьма '+Math.abs(state.reputation)+'</span>'}</div></div>
        <div class="card"><div class="label">Спутник</div><div class="value">${state.companion? state.companion.name : "нет"}</div></div>
      `;
    }
    function choices(list){
      $choices.innerHTML = "";
      list.forEach(({text, action})=>{
        const btn = document.createElement("button");
        btn.className = "choice";
        btn.textContent = text;
        btn.onclick = ()=>{ play("click"); action(); };
        $choices.appendChild(btn);
      });
    }

    // ===== Утилиты =====
    function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
    function chance(p){ return Math.random() < p; }
    function makeWeapon(name,min,max,rarity,affix=null){ return {type:"weapon", name, min, max, rarity, affix}; }
    function equip(item){ if(item && item.type==="weapon"){ state.weapon=item; say(`Ты экипировал: ${item.name}.`); } }
    function heal(amount){ state.hp = Math.min(state.hp + amount, state.maxHp); }
    function setClass(cls){
      state.cls = cls;
      if(cls==="Воин"){ state.maxHp=30; state.hp=30; state.baseDmg=6; }
      if(cls==="Монах"){ state.maxHp=26; state.hp=26; state.baseDmg=5; state.flags.dodge=0.2; }
      if(cls==="Колдун"){ state.maxHp=22; state.hp=22; state.baseDmg=3; state.flags.arcane=1; state.flags.arcaneBolt=true; }
    }
    function repChange(delta){ state.reputation += delta; showStatus(); }

    // ===== Бой и эффекты аффиксов =====
    let enemySlow = 0;
    function rollHeroDmg(){
      let dmg = state.baseDmg + (state.weapon ? randInt(state.weapon.min, state.weapon.max) : 0);
      const isCrit = chance(0.12);
      if(isCrit){ dmg *= 2; play("crit"); } else { play("attack"); }
      // классовые эффекты
      if(state.cls==="Колдун" && state.flags.arcaneBolt && chance(0.25)){ dmg += 3; say("Чародейский разряд (+3)."); }
      if(state.companion && chance(0.2)){ const add = state.companion.bonus||2; dmg += add; say(`${state.companion.name} помогает (+${add}).`); }

      // аффиксы оружия
      if(state.weapon && state.weapon.affix==="вампиризм"){ heal(1); }
      if(state.weapon && state.weapon.affix==="огонь" && chance(0.25)){ dmg += 2; say("Огненный удар (+2)."); }
      if(state.weapon && state.weapon.affix==="мороз" && chance(0.3)){ enemySlow = 1; say("Мороз замедляет врага."); }

      return dmg;
    }
    function enemyAttack(enemy){
      let edmg = randInt(enemy.min, enemy.max);
      edmg = Math.max(0, edmg - enemySlow);
      if(state.cls==="Монах" && chance(state.flags.dodge||0)){ edmg=0; say("Ты уклоняешься."); }
      if(state.cls==="Колдун"){ edmg = Math.max(0, edmg-1); }
      state.hp -= edmg;
      if(edmg>0){ play("hit"); say(`${enemy.name} ранит на ${edmg}. Твоё HP: ${Math.max(state.hp,0)}.`); }
    }
    function combat(enemy, onWin){
      enemySlow = 0;
      say(`Тебя встречает ${enemy.name}.`);
      const loop = ()=>{
        choices([
          { text: "Атаковать", action: ()=>{
            const dmg = rollHeroDmg();
            enemy.hp -= dmg;
            say(`Ты наносишь ${dmg}. У ${enemy.name} осталось ${Math.max(enemy.hp,0)} HP.`);
            if(enemy.hp<=0){
              const gold = enemy.gold||0; state.gold += gold;
              say(`Ты побеждаешь ${enemy.name}. Золото +${gold}.`);
              play("loot"); lootDrop(enemy);
              choices([{text:"Продолжить", action: onWin}]);
              return;
            }
            enemyAttack(enemy);
            if(state.hp<=0){ say("Тьма поглотила тебя. Игра окончена."); choices([{text:"Начать заново", action: restart}]); return; }
            loop();
          }},
          { text: "Использовать лечебный флакон", action: ()=>{
            const idx = state.inventory.findIndex(i=>i.type==="potion");
            if(idx>-1){ const p=state.inventory.splice(idx,1)[0]; heal(p.heal); say(`Флакон: +${p.heal} HP.`); }
            else { say("Флаконов нет."); }
            loop();
          }},
          { text: "Отступить", action: ()=> goto("camp") }
        ]);
        showStatus();
      };
      loop();
    }

    // ===== Лут с аффиксами =====
    function lootDrop(enemy){
      const drops = [];
      if(chance(0.6)) drops.push({type:"gold", amount: randInt(3,10)});
      if(chance(0.4)) drops.push({type:"potion", name:"Лечебный флакон", heal:6});
      if(chance(0.35)){
        const roll = Math.random(); let rarity="normal";
        if(roll>0.85) rarity="rare"; else if(roll>0.6) rarity="magic";
        const affixes = [null, "вампиризм", "мороз", "огонь"];
        const affix = chance(0.4) ? affixes[randInt(1,3)] : null;
        const pool = [
          makeWeapon("Клинок падшего", 2,6, rarity, affix),
          makeWeapon("Святое копьё", 3,7, rarity, affix),
          makeWeapon("Посох тления", 1,8, rarity, affix),
          makeWeapon("Коса душ", 2,9, rarity, affix)
        ];
        drops.push(pool[randInt(0,pool.length-1)]);
      }
      drops.forEach(d=>{
        if(d.type==="gold"){ state.gold += d.amount; }
        else { state.inventory.push(d); }
      });
      showStatus();
    }

    // ===== Сцены и сюжет =====
    const scenes = {
      intro: {
        enter(){
          setAmbientByLocation("intro");
          say("Ночь над Тристрама. Колокол молчит. Шёпот зовёт тебя по имени.");
          choices([
            { text: "Выбрать класс: Воин", action: ()=>{ setClass("Воин"); goto("camp"); } },
            { text: "Выбрать класс: Монах", action: ()=>{ setClass("Монах"); goto("camp"); } },
            { text: "Выбрать класс: Колдун", action: ()=>{ setClass("Колдун"); goto("camp"); } }
          ]);
        }
      },

      camp: {
        enter(){
          setAmbientByLocation("camp");
          say("Лагерь у мостика Тристрама. Путь ведёт в город, лес и часовню.");
          choices([
            { text: "Идти в Тристрама (город)", action: ()=> goto("tristram") },
            { text: "Пойти в лес", action: ()=> goto("forest") },
            { text: "К часовне", action: ()=> goto("chapel") },
            { text: "Осмотреть лагерь", action: ()=>{
              if(!state.flags.cache){ state.flags.cache=true; state.gold+=12; state.inventory.push({type:"potion", name:"Лечебный флакон", heal:6}); play("loot"); say("Тайник: 12 золота и флакон."); }
              else say("Ничего нового.");
              choices([{text:"Вернуться", action: ()=> goto("camp")}]);
            } }
          ]);
        }
      },

      tristram: {
        enter(){
          setAmbientByLocation("tristram");
          say("Тристрама в страхе. Торговцы, таверна и слухи о Башне магов.");
          choices([
            { text: "Кузнец: улучшить оружие (5 золота)", action: ()=>{
              if(state.weapon && state.gold>=5){ state.gold-=5; state.weapon.min++; state.weapon.max++; play("loot"); say("Кузнец усиливает твоё оружие."); }
              else if(!state.weapon){ say("Принеси железо, не воздух."); } else { say("Нужно больше золота."); }
              choices([{text:"Назад", action: ()=> goto("tristram")}]);
            }},
            { text: "Алхимик: купить флакон (3 золота)", action: ()=>{
              if(state.gold>=3){ state.gold-=3; state.inventory.push({type:"potion", name:"Лечебный флакон", heal:6}); play("loot"); say("Алхимик даёт флакон, шепча рецепт."); }
              else { say("Алхимик: тьма не берёт в долг."); }
              choices([{text:"Назад", action: ()=> goto("tristram")}]);
            }},
            { text: "Таверна: нанять наёмника (8 золота)", action: ()=>{
              if(state.companion){ say("Ты уже не один."); choices([{text:"Назад", action: ()=> goto("tristram")}]); return; }
              if(state.gold>=8){ state.gold-=8; state.companion = {name:"Наёмник", bonus:2}; play("loot"); say("Наёмник кивает: 'Пока платишь — я с тобой.'"); }
              else { say("Наёмник: вернись с монетами."); }
              choices([{text:"Назад", action: ()=> goto("tristram")}]);
            }},
            { text: "Старуха: слухи о Башне магов", action: ()=> goto("tower") },
            { text: "Помочь вдове очистить колодец (+доблесть)", action: ()=>{
              if(!state.flags.well){ state.flags.well=true; repChange(+1); say("Колодец очищен. Город надеется на тебя."); }
              else say("Колодец чист.");
              choices([{text:"Назад", action: ()=> goto("tristram")}]);
            }},
            { text: "Вернуться в лагерь", action: ()=> goto("camp") }
          ]);
        }
      },

      forest: {
        enter(){
          setAmbientByLocation("forest");
          say("Тёмный лес. Тропы ведут к Проклятым полям.");
          choices([
            { text: "Сразиться с падшим", action: ()=> combat({name:"Падший демон", hp:12, min:1, max:4, gold:4}, ()=> goto("forest")) },
            { text: "Обыскать чащу", action: ()=>{
              if(chance(0.5)){ state.inventory.push({type:"potion", name:"Флакон травника", heal:5}); play("loot"); say("Находишь травяной флакон."); }
              else { say("Только шорохи и пустота."); }
              choices([{text:"Назад", action: ()=> goto("forest")}]);
            }},
            { text: "Идти на Проклятые поля", action: ()=> goto("fields") },
            { text: "Вернуться в лагерь", action: ()=> goto("camp") }
          ]);
        }
      },

      fields: {
        enter(){
          setAmbientByLocation("fields");
          say("Проклятые поля. Ветер несёт пепел. Орды падших собираются.");
          choices([
            { text: "Засада стаи падших", action: ()=> combat({name:"Вожак стаи", hp:18, min:2, max:5, gold:8}, ()=> goto("fields")) },
            { text: "Странствующий паладин — выбор", action: ()=>{
              say("Паладин просит помочь очистить часовню от скверны.");
              choices([
                { text:"Помочь (+доблесть)", action: ()=>{ repChange(+1); goto("chapel"); } },
                { text:"Отказать (+тьма)", action: ()=>{ repChange(-1); say("Паладин молча уходит."); goto("fields"); } }
              ]);
            }},
            { text: "Возврат в лес", action: ()=> goto("forest") }
          ]);
        }
      },

      chapel: {
        enter(){
          setAmbientByLocation("chapel");
          say("Часовня Тристрама. Врата ведут в катакомбы.");
          choices([
            { text: "Спуститься в катакомбы", action: ()=> goto("catacombs") },
            { text: "Осмотреть хоры", action: ()=>{
              if(!state.flags.chapelKey){ state.flags.chapelKey=true; state.inventory.push({type:"key", name:"Ключ катакомб"}); play("loot"); say("Под пюпитром — ржавый ключ."); }
              else say("Ты уже забрал ключ.");
              choices([{text:"Назад", action: ()=> goto("chapel")}]);
            }},
            { text: "Вернуться в лагерь", action: ()=> goto("camp") }
          ]);
        }
      },

      tower: {
        enter(){
          setAmbientByLocation("tower");
          say("Башня магов. Гримуар поёт кровью. Здесь ждут руны и искушение.");
          const options = [
            { text: "Гримуар: жертва 2 HP (+урон)", action: ()=>{
              if(!state.flags.grimoire){ state.flags.grimoire=true; state.baseDmg+=2; state.hp=Math.max(1,state.hp-2); play("boss"); say("Руны усиливают силу, требуют плату."); }
              else say("Гримуар насытился.");
              choices([{text:"Назад", action: ()=> goto("tower")}]);
            }},
            { text: "Изучить заклинание (Колдун)", action: ()=>{
              if(state.cls==="Колдун" && !state.flags.arcaneBoltLearned){ state.flags.arcaneBoltLearned=true; state.flags.arcaneBolt=true; say("Изучено: Чародейский разряд (+3 иногда)."); }
              else if(state.cls!=="Колдун"){ say("Руны закрыты для непосвящённых."); }
              else { say("Ты уже владеешь этим."); }
              choices([{text:"Назад", action: ()=> goto("tower")}]);
            }},
            { text: "Квест Монаха: очистить башню", action: ()=>{
              if(state.cls==="Монах" && !state.flags.monkQuest){
                combat({name:"Призрак башни", hp:18, min:2, max:5, gold:5}, ()=>{
                  state.flags.monkQuest=true; state.flags.dodge = (state.flags.dodge||0)+0.1;
                  say("Ты очистил башню. Дух крепчает (+уклонение).");
                  choices([{text:"Назад", action: ()=> goto("tower")}]);
                });
              } else { say("Этот путь закрыт или уже завершён."); choices([{text:"Назад", action: ()=> goto("tower")}]); }
            }},
            { text: "Квест Колдуна: Руны крови", action: ()=>{
              if(state.cls==="Колдун" && !state.flags.bloodRunes){
                say("Руны требуют каплю жизни ради знания. Принять?");
                choices([
                  { text:"Принять (-1 HP, открыть Огненный шар)", action: ()=>{
                    state.flags.bloodRunes=true; state.flags.fireball=true; state.hp=Math.max(1,state.hp-1);
                    say("Ты вписываешь руны в кровь. Открыт 'Огненный шар' (+5 иногда, -1 HP при изучении).");
                    choices([{text:"Назад", action: ()=> goto("tower")}]);
                  }},
                  { text:"Отказаться", action: ()=> goto("tower") }
                ]);
              } else { say("Руны молчат."); choices([{text:"Назад", action: ()=> goto("tower")}]); }
            }},
            { text: "Вернуться в город", action: ()=> goto("tristram") }
          ];
          choices(options);
        }
      },

      catacombs: {
        enter(){
          setAmbientByLocation("catacombs");
          say("Катакомбы. Кости хрустят под ногами. Тьма ждёт глубже.");
          choices([
            { text:"Продвигаться — Скелет-воин", action: ()=> combat({name:"Скелет-воин", hp:16, min:2, max:5, gold:7}, ()=> goto("catacombs")) },
            { text:"Алтарь крови (сила за цену)", action: ()=>{
              if(!state.flags.bloodAltar){ state.flags.bloodAltar=true; state.baseDmg+=1; state.hp=Math.max(1,state.hp-2); repChange(-1); play("boss"); say("Ты жертвуешь кровь. Люди будут бояться тебя."); }
              else say("Алтарь молчит.");
              choices([{text:"Назад", action: ()=> goto("catacombs")}]);
            }},
            { text:"Врата к склепу", action: ()=>{
              if(!state.flags.chapelKey){ say("Нужен ключ катакомб."); choices([{text:"Назад", action: ()=> goto("catacombs")}]); }
              else { play("portal"); goto("crypt"); }
            }},
            { text:"Спуститься глубже (уровни)", action: ()=> goto("deepCatacombs") },
            { text:"Вернуться к часовне", action: ()=> goto("chapel") }
          ]);
        }
      },

      deepCatacombs: {
        enter(){
          setAmbientByLocation("deepCatacombs");
          say("Глубокие уровни. Воздух густеет, шёпот имён режет слух.");
          choices([
            { text:"Ловушка костей (−3 HP)", action: ()=>{
              state.hp = Math.max(1, state.hp-3);
              say("Лезвия костей ранят тебя. Тьма довольна.");
              choices([{text:"Дальше", action: ()=> goto("deepCatacombs")}]);
            }},
            { text:"Бой с Призраком стража", action: ()=> combat({name:"Призрак стража", hp:20, min:2, max:6, gold:10}, ()=> goto("deepCatacombs")) },
            { text:"Трон Повелителя (финал)", action: ()=>{
              if(!state.flags.relic){ say("Врата закрыты. Нужна Реликвия души из склепа."); choices([{text:"Назад", action: ()=> goto("deepCatacombs")}]); }
              else {
                play("boss");
                combat({name:"Повелитель тьмы", hp:28, min:3, max:8, gold:25}, ()=>{
                  state.flags.finalBoss=true;
                  const ending = state.reputation>=0
                    ? "Ты стал защитником Тристрама. Свет вернулся — на время."
                    : "Город боится тебя так же, как и тьму. Но врата адских глубин закрыты.";
                  say(ending);
                  choices([{text:"Вернуться в лагерь", action: ()=> goto("camp")}]);
                });
              }
            }},
            { text:"Назад в катакомбы", action: ()=> goto("catacombs") }
          ]);
        }
      },

      crypt: {
        enter(){
          setAmbientByLocation("crypt");
          say("Склеп. На пьедестале лежит реликвия.");
          choices([
            { text:"Взять Реликвию души", action: ()=>{
              if(!state.flags.relic){ state.flags.relic=true; state.inventory.push({type:"quest", name:"Реликвия души"}); play("loot"); say("Воздух дрожит. Ты берёшь реликвию."); }
              else say("Пьедестал пуст.");
              choices([{text:"Назад", action: ()=> goto("crypt")}]);
            }},
            { text:"Покинуть склеп", action: ()=> goto("catacombs") }
          ]);
          if(state.flags.relic && !state.flags.bossDefeated){
            play("boss");
            combat({name:"Сторож Лазаря", hp:24, min:3, max:7, gold:20}, ()=>{
              state.flags.bossDefeated=true;
              say("Сторож пал. Тишина возвращается, но ненадолго.");
              choices([{text:"Вернуться к склепу", action: ()=> goto("crypt")}]);
            });
          }
        }
      }
    };

    // ===== Навигация =====
    function goto(id){
      const scene = scenes[id];
      if(!scene){ say("Тропа теряется в тумане."); return; }
      state.location = id;
      scene.enter();
      showStatus();
    }

    // ===== Контролы =====
    function restart(){
      state.name="Странник";
      state.cls=null;
      state.hp=24; state.maxHp=24;
      state.gold=0; state.level=1;
      state.baseDmg=4;
      state.weapon=null;
      state.inventory=[];
      state.reputation=0;
      state.companion=null;
      state.location="intro";
      state.flags={};
      setAmbientByLocation("intro");
      goto("intro");
    }

    // ===== Доп. боевые эффекты для Колдуна (огненный шар) =====
    const originalRollHeroDmg = rollHeroDmg;
    rollHeroDmg = function(){
      let dmg = originalRollHeroDmg();
      if(state.cls==="Колдун" && state.flags.fireball && chance(0.2)){
        dmg += 5;
        say("Огненный шар разрывает тьму (+5).");
      }
      return dmg;
    };

    // ===== События UI =====
    $restart.addEventListener("click", restart);
    document.addEventListener("visibilitychange", ()=>{
      if(document.hidden) stopAmbients();
      else if(state.soundOn) setAmbientByLocation(state.location);
    });

    // Старт
    restart();
  </script>
</body>
</html>
